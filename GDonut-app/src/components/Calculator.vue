<template>
  <div>
    <q-file filled bottom-slots v-model="filePicker" label="Label" counter>
      <template v-slot:prepend>
        <q-icon name="cloud_upload" @click.stop />
      </template>
      <template v-slot:append>
        <q-icon
          name="close"
          @click.stop="filePicker = null"
          class="cursor-pointer"
        />
      </template>
    </q-file>
  </div>
  <div class="full-width row justify-center">
    <q-input v-model="polyString" label="Polinomio" :loading="calc" />
    <div class="q-gutter-sm content-align-center">
      <q-btn round color="primary" icon="send" @click="showGeneo()" />
    </div>
  </div>
  <div class="full-width row justify-center">
    <div class="column justify-start">
      <canvas
        class="q-mt-md q-mb-xs"
        id="myCanvasGeneo"
        :width="xCanvas"
        :height="yCanvas"
        style="border: 1px solid blue"
      >
        Your browser does not support the HTML5 canvas tag.</canvas
      >
      <div class="row justify-start">
        <small>{{ xCanvas }} X {{ yCanvas }} </small>
      </div>
    </div>
  </div>
  <div class="full-width row justify-center">
    <canvas
      class="q-ma-md"
      id="myCanvas1"
      :width="xCanvas"
      :height="yCanvas"
      style="border: 1px solid blue"
    >
      Your browser does not support the HTML5 canvas tag.</canvas
    >
  </div>

  <q-dialog v-model="alertPopup">
    <q-card>
      <q-card-section>
        <div class="text-h6">Errore nel polinomio inserito</div>
      </q-card-section>

      <q-card-section class="q-pt-none">
        the polynomial in input contains wrong or compound characters in an
        erroneous formulation:
        <br />
        permutants allowed are : a_1(x,y) | a_2(degree)
        <br />
        shortcut: halfX = (image width)/2 | halfY = (image height)/2
      </q-card-section>

      <q-card-actions align="right">
        <q-btn flat label="OK" color="primary" v-close-popup />
      </q-card-actions>
    </q-card>
  </q-dialog>
</template>

<script setup lang="ts">
import { Matrix } from "ml-matrix";
import { onMounted, ref, watch } from "vue";
import { useMatrixCanvas } from "../composables/useMatrixCanvas";
import { usePoly } from "../composables/usePoly";

const polyString = ref<string>("");
const calc = ref(false);
const filePicker = ref<File | null>();

var myCanvasGeneo: HTMLCanvasElement;
var myCanvas1: HTMLCanvasElement;

var testImg = new Image();
var testImgMatrix: Matrix;

const xCanvas = ref<number>(0);
const yCanvas = ref<number>(0);

var alertPopup = ref<boolean>(false);

const showGeneo = () => {
  calc.value = true;
  try {
    var geneoMatrix = usePoly().evalPoly(
      polyString.value,
      testImgMatrix,
      testImg
    );
  } catch (e) {
    alertPopup.value = true;
    return;
  }
  if (geneoMatrix) {
    useMatrixCanvas().drawMatrix(geneoMatrix, myCanvasGeneo);
  }
  calc.value = false;
};

const initTestImage = () => {
  var ctx = myCanvas1.getContext("2d");
  ctx?.clearRect(0, 0, myCanvas1.width, myCanvas1.height);

  ctx!.drawImage(testImg, 0, 0);

  var testImgData = ctx!.getImageData(0, 0, testImg.width, testImg.height);
  testImgMatrix = useMatrixCanvas().arrayCanvasToMatrix(
    testImgData.data,
    testImg.width,
    testImg.height
  );
};

onMounted(() => {
  myCanvas1 = <HTMLCanvasElement>document.getElementById("myCanvas1");
  myCanvasGeneo = <HTMLCanvasElement>document.getElementById("myCanvasGeneo");

  testImg.src = "../../grey.png";
  testImg.onload = () => initTestImage();

  xCanvas.value = testImg.width;
  yCanvas.value = testImg.height;
});

watch(
  filePicker,
  (newVal) => {
    if (newVal) {
      var reader = new FileReader();
      reader.onload = () => {
        testImg.src = reader.result as string;
        testImg.onload = () => initTestImage();
      };
      reader.readAsDataURL(newVal);
    }
  },
  { immediate: true }
);
</script>

<style scoped></style>
